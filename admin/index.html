<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Voting Admin | Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background: #0f172a;
      color: white;
      font-family: sans-serif;
      padding: 20px;
    }
    h1 { color: cyan; }
    button { padding: 10px 16px; border: none; background: cyan; color: #000; cursor: pointer; margin: 10px 0; border-radius: 6px; }
    .event-card {
      background: #1e293b;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .popup {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    .popup-content {
      background: #fff;
      color: #000;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      border-radius: 8px;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .logo-preview {
      width: 100px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Event Admin Dashboard</h1>
  <button onclick="openPopup()">+ Create New Event</button>

  <div id="eventList"></div>

  <!-- Popup -->
  <div class="popup" id="popup">
    <div class="popup-content">
      <h3>Create Event</h3>
      <input type="text" id="eventTitle" placeholder="Event Title" required />
      <textarea id="eventDesc" placeholder="Event Description"></textarea>
      <input type="date" id="startDate" />
      <input type="date" id="endDate" />
      <input type="file" id="eventLogo" accept="image/*" onchange="previewLogo()" />
      <img id="logoPreview" class="logo-preview" style="display:none" />
      <button onclick="createEvent()">Submit</button>
      <button onclick="closePopup()">Cancel</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyCMEyb1jdntV14bKVvoPBaApB2wi-yTz6c",
  authDomain: "jasdy-vote.firebaseapp.com",
  projectId: "jasdy-vote",
  storageBucket: "jasdy-vote.firebasestorage.app",
  messagingSenderId: "191017072761",
  appId: "1:191017072761:web:c1b0a30d75dcbc94173ca8",
  measurementId: "G-MELT3K9R0T"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const popup = document.getElementById('popup');
    const eventList = document.getElementById('eventList');
    let logoBase64 = "";

    function openPopup() {
      popup.style.display = "flex";
    }

    function closePopup() {
      popup.style.display = "none";
    }

    window.openPopup = openPopup;
    window.closePopup = closePopup;

    window.previewLogo = () => {
      const file = document.getElementById('eventLogo').files[0];
      const reader = new FileReader();
      reader.onloadend = () => {
        logoBase64 = reader.result;
        const preview = document.getElementById('logoPreview');
        preview.src = logoBase64;
        preview.style.display = 'block';
      };
      if (file) reader.readAsDataURL(file);
    };

    window.createEvent = async () => {
      const title = document.getElementById('eventTitle').value.trim();
      const desc = document.getElementById('eventDesc').value.trim();
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const id = "EVT" + Date.now();

      if (!title || !start || !end || !logoBase64) {
        alert("Fill in all fields and upload a logo.");
        return;
      }

      const eventData = { title, desc, logo: logoBase64, start, end, eventId: id };

      try {
        await addDoc(collection(db, "events"), eventData);
        alert("Event created.");
        closePopup();
        loadEvents();
      } catch (e) {
        alert("Error: " + e.message);
      }
    };

    async function loadEvents() {
      eventList.innerHTML = "";
      const snapshot = await getDocs(collection(db, "events"));
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const el = document.createElement("div");
        el.className = "event-card";
        el.innerHTML = `
          <img src="${data.logo}" style="width:80px;height:80px;border-radius:10px" />
          <h3>${data.title}</h3>
          <p>${data.desc}</p>
          <p><strong>ID:</strong> ${data.eventId}</p>
          <p><strong>From:</strong> ${data.start} <strong>To:</strong> ${data.end}</p>
          <p><a href="organizer.html?eventId=${data.eventId}">Share Link</a></p>
          <button onclick="deleteEvent('${docSnap.id}')">Delete</button>
        `;
        eventList.appendChild(el);
      });
    }

    window.deleteEvent = async (docId) => {
      if (!confirm("Delete this event?")) return;
      try {
        await deleteDoc(doc(db, "events", docId));
        loadEvents();
      } catch (e) {
        alert("Error deleting: " + e.message);
      }
    };

    loadEvents();
  </script>
</body>
</html>